<!DOCTYPE html>

<html>

<head>
  <style>
    #info {
      position: absolute;
      top: 2%;
      width: 100%;
      padding: 10px;
      text-align: center;
      color: #ffff00
    }
	#toggle {
      position: absolute;
      left: 50vw;
      top: 10px;
    }

    body {
      overflow: hidden;
    }
  </style>
</head>

<body>

  <script id="vsFilter" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
        gl_Position = projectionMatrix* modelViewMatrix * vec4( position, 1.0);
        vUv = uv;
    }
  </script>
  <script id="fsFilter" type="x-shader/x-fragment">
    uniform sampler2D texture;
    varying vec2 vUv;
  	uniform float grain;

    void main() {
    	vec2 uuvv = floor (vUv*grain)/grain;
    	gl_FragColor = texture2D(texture, uuvv);
    }
  </script>

  <script id="vsFilter2" type="x-shader/x-vertex">
    varying vec2 vUv;
    void main() {
        gl_Position = projectionMatrix* modelViewMatrix * vec4( position, 1.0);
        vUv = uv;
    }
  </script>
  <script id="fsFilter2" type="x-shader/x-fragment">
    uniform sampler2D texture;
    varying vec2 vUv;
    uniform float theta;
	uniform float display;
	
	void line(float dis, float dis2, float dis3, float dis4, float rate){
		vec4 color;
		if(display < 1.0) discard;
		else if(dis < (0.02/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			//else
			  //discard;
		}
		else if(dis < (0.04/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			//else
			  //discard;
		}
		else if(dis < (0.06/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			//else
			  //discard;
		}
		else if(dis < (0.08/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			//else
			  //discard;
		}
		else if(dis < (0.10/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			//else
			  //discard;
		}
		else if(dis < (0.12/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			//else
			  //discard;
		}
		else if(dis < (0.14/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			//else
			  //discard;
		}
		else if(dis < (0.16/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			//else
			  //discard;
		}
		else if(dis < (0.18/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			//else
			  //discard;
		}
		else if(dis < (0.20/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			//else
			  //discard;
		}
		else if(dis2 < (0.02/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			//else
			  //discard;
		}
		else if(dis2 < (0.04/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			//else
			  //discard;
		}
		else if(dis2 < (0.06/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			//else
			  //discard;
		}
		else if(dis2 < (0.08/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			//else
			  //discard;
		}
		else if(dis2 < (0.10/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			//else
			  //discard;
		}
		else if(dis2 < (0.12/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			//else
			  //discard;
		}
		else if(dis2 < (0.14/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			//else
			  //discard;
		}
		else if(dis2 < (0.16/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			//else
			  //discard;
		}
		else if(dis2 < (0.18/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			//else
			  //discard;
		}
		else if(dis2 < (0.20/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			//else
			  //discard;
		}
		else if(dis3 < (0.02/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			//else
			  //discard;
		}
		else if(dis3 < (0.04/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			//else
			  //discard;
		}
		else if(dis3 < (0.06/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			//else
			  //discard;
		}
		else if(dis3 < (0.08/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			//else
			  //discard;
		}
		else if(dis3 < (0.10/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			//else
			  //discard;
		}
		else if(dis3 < (0.12/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			//else
			  //discard;
		}
		else if(dis3 < (0.14/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			//else
			  //discard;
		}
		else if(dis3 < (0.16/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			//else
			  //discard;
		}
		else if(dis3 < (0.18/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			//else
			  //discard;
		}
		else if(dis3 < (0.20/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			//else
			  //discard;
		}
		else if(dis4 < (0.02/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			//else
			  //discard;
		}
		else if(dis4 < (0.04/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			//else
			  //discard;
		}
		else if(dis4 < (0.06/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			//else
			  //discard;
		}
		else if(dis4 < (0.08/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			//else
			  //discard;
		}
		else if(dis4 < (0.10/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			//else
			  //discard;
		}
		else if(dis4 < (0.12/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			//else
			  //discard;
		}
		else if(dis4 < (0.14/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			//else
			  //discard;
		}
		else if(dis4 < (0.16/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			//else
			  //discard;
		}
		else if(dis4 < (0.18/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			//else
			  //discard;
		}
		else if(dis4 < (0.20/rate)){
			color = texture2D(texture, vUv);
			//if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			//else
			  //discard;
		}
		else
			//discard;
			gl_FragColor = vec4(1,1,1, 1);
	}
	void lineCut(float dis, float dis2, float dis3, float dis4, float rate){
		vec4 color;
		if(display < 1.0) discard;
		else if(dis < (0.02/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			else
			  discard;
		}
		else if(dis < (0.04/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			else
			  discard;
		}
		else if(dis < (0.06/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			else
			  discard;
		}
		else if(dis < (0.08/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			else
			  discard;
		}
		else if(dis < (0.10/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			else
			  discard;
		}
		else if(dis < (0.12/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			else
			  discard;
		}
		else if(dis < (0.14/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			else
			  discard;
		}
		else if(dis < (0.16/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			else
			  discard;
		}
		else if(dis < (0.18/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			else
			  discard;
		}
		else if(dis < (0.20/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			else
			  discard;
		}
		else if(dis2 < (0.02/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			else
			  discard;
		}
		else if(dis2 < (0.04/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			else
			  discard;
		}
		else if(dis2 < (0.06/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			else
			  discard;
		}
		else if(dis2 < (0.08/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			else
			  discard;
		}
		else if(dis2 < (0.10/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			else
			  discard;
		}
		else if(dis2 < (0.12/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			else
			  discard;
		}
		else if(dis2 < (0.14/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			else
			  discard;
		}
		else if(dis2 < (0.16/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			else
			  discard;
		}
		else if(dis2 < (0.18/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			else
			  discard;
		}
		else if(dis2 < (0.20/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			else
			  discard;
		}
		else if(dis3 < (0.02/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			else
			  discard;
		}
		else if(dis3 < (0.04/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			else
			  discard;
		}
		else if(dis3 < (0.06/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			else
			  discard;
		}
		else if(dis3 < (0.08/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			else
			  discard;
		}
		else if(dis3 < (0.10/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			else
			  discard;
		}
		else if(dis3 < (0.12/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			else
			  discard;
		}
		else if(dis3 < (0.14/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			else
			  discard;
		}
		else if(dis3 < (0.16/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			else
			  discard;
		}
		else if(dis3 < (0.18/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			else
			  discard;
		}
		else if(dis3 < (0.20/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			else
			  discard;
		}
		else if(dis4 < (0.02/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 1.0);
			else
			  discard;
		}
		else if(dis4 < (0.04/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.9);
			else
			  discard;
		}
		else if(dis4 < (0.06/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.8);
			else
			  discard;
		}
		else if(dis4 < (0.08/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.7);
			else
			  discard;
		}
		else if(dis4 < (0.10/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.6);
			else
			  discard;
		}
		else if(dis4 < (0.12/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.5);
			else
			  discard;
		}
		else if(dis4 < (0.14/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.4);
			else
			  discard;
		}
		else if(dis4 < (0.16/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.3);
			else
			  discard;
		}
		else if(dis4 < (0.18/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.2);
			else
			  discard;
		}
		else if(dis4 < (0.20/rate)){
			color = texture2D(texture, vUv);
			if(color.rg != vec2(1.0, 1.0))
			  gl_FragColor = vec4(color.rgb, 0.1);
			else
			  discard;
		}
		else
			discard;
			//gl_FragColor = vec4(1,1,1, 1);
	}
    void main() {
      //vec4 color;

      //float a = 0.0, b = 3.0, c = 0.0;
      //float _a = cos(theta)*a - sin(theta)*b, _b = sin(theta)*a + cos(theta)*b;
      //float dis = abs( _a*vUv.x + _b*vUv.y + c)/sqrt(_a*_a+_b*_b);
	  vec2 p0, p1, pj;
      p0 = vec2(cos(theta) - 0.5, sin(theta) - 0.5); //6.28
      p1 = vec2(vUv.x - 0.5, vUv.y - 0.5);
      float pjl = dot(p0, p1)/length(p0);
      pj = pjl*(p0/length(p0));
      float dis = length(p1-pj);
	  
	  vec2 p02, p12, pj2;
      p02 = vec2(cos(theta-1.1) - 0.5, sin(theta-1.1) - 0.5);
      p12 = vec2(vUv.x - 0.5, vUv.y - 0.5);
      float pjl2 = dot(p02, p12)/length(p02);
      pj2 = pjl2*(p02/length(p02));
	  float dis2 = length(p12-pj2);
	  
	  vec2 p03, p13, pj3;
      p03 = vec2(cos(theta-2.5) - 0.5, sin(theta-2.5) - 0.5);
      p13 = vec2(vUv.x - 0.5, vUv.y - 0.5);
      float pjl3 = dot(p03, p13)/length(p03);
      pj3 = pjl3*(p03/length(p03));
	  float dis3 = length(p13-pj3);
	  
	  vec2 p04, p14, pj4;
      p04 = vec2(cos(theta-3.6) - 0.5, sin(theta-3.6) - 0.5);
      p14 = vec2(vUv.x - 0.5, vUv.y - 0.5);
      float pjl4 = dot(p04, p14)/length(p04);
      pj4 = pjl4*(p04/length(p04));
	  float dis4 = length(p14-pj4);
	  
	  
	  float rate = 2.0;//1.5;
	  //line(dis, dis2, dis3, dis4, rate);
	  lineCut(dis, dis2, dis3, dis4, rate);
		
    }
  </script>
  
  <!--input type="button" id="toggle" value="start"-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.5.1/dat.gui.min.js"></script>
  <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
  <script src="js/libs/ammo.js"></script>
  <script type="module">

  import * as THREE from './build/three.module.js';
  import Stats from './jsm/libs/stats.module.js';
  import { OrbitControls } from './jsm/controls/OrbitControls.js';
  import { OutlineEffect } from './jsm/effects/OutlineEffect.js';
  import { MMDLoader } from './jsm/loaders/MMDLoader.js';
  import { MMDAnimationHelper } from './jsm/animation/MMDAnimationHelper.js';
	  var scene, renderer, camera, stats;
    var WIDTH, HEIGHT;
    var offset;
    var camera, scene, renderer, mesh, plan, plan2, light;
    var bufferScene, bufferTexture, bufferCamera, material_shh, material_shh2, LEDs = [], LEDNum = 50;
    var modelFile = 'models/serval/serval.pmx';
    var vmdFiles = 'vmds/wavefile_v2.vmd';
    var loader, helper, ikHelper, physicsHelper, effect;
    var clock = new THREE.Clock();
    var angle = 0, fan = new THREE.Object3D(), toggle = false;
	//var speed = 10;
	var gcontrols;


  Ammo().then(function(AmmoLib) {
    Ammo = AmmoLib;
  	init();
  	animate();
  });
  


	function init() {
	  scene = new THREE.Scene();
	  scene.background = new THREE.Color(0x888888);

	  renderer = new THREE.WebGLRenderer({antialias:true});
	   WIDTH = window.innerWidth;
	   HEIGHT = window.innerHeight;
	  renderer.setSize(WIDTH, HEIGHT);
	  //renderer.setClearColor(0x888888);
	  document.body.appendChild(renderer.domElement);

	  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.5, 1000);
	  //camera.position.z = 50;
	  camera.position.set(0,0,20);

    stats = new Stats();
    stats.showPanel(0);
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.left = '0px';
    stats.domElement.style.top = '0px';
    document.body.appendChild(stats.domElement);

	  let controls = new OrbitControls(camera, renderer.domElement);
  	controls.enableKeys = false;

    var light = new THREE.DirectionalLight(0xffffff);
    light.position.set(50, 100, 0);
    scene.add(light);

    effect = new OutlineEffect(renderer);

    var gridHelper = new THREE.GridHelper( 100, 50 , 'red', 'white');
    //scene.add(gridHelper);
    /////////

    ///////////////////
    bufferScene = new THREE.Scene();
    bufferScene.background = new THREE.Color(0xffff00);
    //bufferCamera= new THREE.PerspectiveCamera(60, 1, 0.1, 500);
    bufferCamera = new THREE.PerspectiveCamera( 60, 1, 0.1, 1000 );
    bufferCamera.position.z = 25;
    bufferScene.add(bufferCamera);

    var lightB = new THREE.DirectionalLight(0x888888);
    lightB.position.set(10, 20, 20);
    bufferScene.add(lightB);

    initModel(modelFile, vmdFiles);

    bufferTexture = new THREE.WebGLRenderTarget(
         1024, 1024, {
         minFilter: THREE.LinearFilter,
         magFilter: THREE.NearestFilter
         });

    ///////////////////
    
    ///////////////////////////////////////////////////////////
	
	///////////////////////////////////////////////////////////
    var vertShader2 = document.getElementById('vsFilter2').innerHTML;
    var fragShader2 = document.getElementById('fsFilter2').innerHTML;
    material_shh2 = new THREE.ShaderMaterial({
      uniforms: {
        texture: {
        	type: 't',
          value: bufferTexture.texture
        },
        theta:{
          type:'f',
          value: 0.0
        },
        display:{
          type:'f',
          value: 1.0
        }

      },
      vertexShader: vertShader2,
      fragmentShader: fragShader2
    });
    material_shh2.transparent = true;
    plan2 = new THREE.Mesh (new THREE.PlaneGeometry (20, 20), material_shh2);
    plan2.position.y = 0;
    plan2.position.x = 0;
    plan2.position.z = 0;
    scene.add(plan2);
	
	gcontrols = {
		speed: 5
	};

	var gui = new dat.GUI();
	gui.domElement.id = 'gui';

	gui.add(gcontrols, 'speed', 1, 10);
	
	
    
  }

	function onWindowResize() {
	  camera.aspect = window.innerWidth / window.innerHeight;
	  camera.updateProjectionMatrix();
	  renderer.setSize(window.innerWidth, window.innerHeight);
	}

	function animate() {
		stats.begin();
		stats.end();
		requestAnimationFrame(animate);
		var delta = clock.getDelta();
		angle += delta*gcontrols.speed*10;

		helper.update(delta);
		effect.render(scene, camera);
		//fan.children[0].rotation.z = -Math.PI/4 + angle - Math.cos(angle) + Math.sin(angle);
		material_shh2.uniforms["theta"].value = angle;

		renderer.setRenderTarget(bufferTexture);
		renderer.render(bufferScene, bufferCamera);
		renderer.setRenderTarget(null);
		renderer.render(scene, camera);


	}

  function initModel(model, vmd){
    ///model

    function onProgress(xhr) {
      if (xhr.lengthComputable) {
        var percentComplete = xhr.loaded / xhr.total * 100;
        console.log(Math.round(percentComplete, 2) + '% downloaded');
      }
    };

    function onError(xhr) {};

    var loader = new MMDLoader();
    console.log(model);

    helper = new MMDAnimationHelper({
      afterglow: 2.0
    });

    loader.loadWithAnimation(model, vmd, function(mmd){
        mesh = mmd.mesh;
        mesh.position.set(0, -10, 0);
        bufferScene.add(mesh);

        helper.add( mesh, {
					animation: mmd.animation,
					physics: true
				} );


    },onProgress, onError);

  }
  
</script>
</body>

</html>
